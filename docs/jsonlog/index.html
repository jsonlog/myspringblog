<!doctype html>
<html>
<head runat="server">
    <meta charset="utf-8">
    <title>首页_老G博客网站</title>
    <meta name="keywords" content="个人博客,老G个人博客,个人博客模板,老G" />
    <meta name="description" content="老G个人博客，是一个支持springboot个人原创网站。" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./../css/base.css" rel="stylesheet"/>
    <link href="./../css/index.css" rel="stylesheet"/>
    <link href="./../css/m.css" rel="stylesheet"/>
    <link href="./../css/music.css" rel="stylesheet"/>
    <script src="./../js/jquery.min.js" ></script>
    <link href="./../css/calendar.css" rel="stylesheet" />
    <script src="./../js/calendar.js" type="text/javascript"></script>
    <script src="./../js/fest.js" type="text/javascript"></script>
    <script src="./../js/hc-sticky.js"></script>
    <script src="./../js/comm.js"></script>
    <!--[if lt IE 9]>
    <script src="./../js/modernizr.js"></script>
    <![endif]-->
    <!--  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <!--  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>-->
    <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css"/>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div id="header"></div>
<script>
    $("#header").load("./../jsonlog/header.html");
</script>
<div id="wrapper" class="wrapper">
    <form>
        <main id="main" style="width:65%;display:inline-block;vertical-align: top;">
            <div class="bloglist">
                <ul id="bloglistul">
                </ul>
            </div>
            <div id="blogurl">
            </div>
            <div id="container"></div>
        </main>
        <div style="text-align:left;width: 32%;padding-left:30px;display:inline-block;vertical-align: top;">
            <iframe class="about" style="padding-bottom: 15px" width="100%" scrolling="no" height="70" frameborder="0" allowtransparency="true" src="//i.tianqi.com/index.php?c=code&id=2&icon=1&num=3&site=12"></iframe>
            <div id="calendar" style="margin-bottom:15px;" onload="fest();">
            </div>
            <div id="aside">
            </div>
        </div>
    </form>
    <!--  </div>-->
</div>
<script>
    function aside(blogtagslist) {
        $("#aside").load("./../jsonlog/aside.html");
        var cloud = document.getElementById("tag");
        blogtagslist.forEach(function (element, index, array) {
            cloud.innerHTML += '<a href="#" onclick="tagClick(\''+element+'\');">'+element+'</a>';
        });
    }
</script>
<script>
    $.ajaxSetup({
        async : false
    });
    var realloc = location.href;
    var myloc = realloc.split("&code=");
    var loc = myloc[0];
    // var code = myloc[1];
    // if(loc[loc.length -1] != "?")
    var n1 = loc.length;//地址的总长度
    var n2 = loc.indexOf("=");//取得=号的位置
    var dengyu = loc.substr(n2+1, n1-n2);
    if(loc.indexOf("?tag=") != -1)
        var tag = decodeURI(dengyu);//从=号后面的内容
    else if(loc.indexOf("?url=") != -1)
        var url = decodeURI(dengyu);
    if(url) urlClick(url);
    else tagClick();
    function githubblog() {
        $.ajax({
            url: "https://api.github.com/repos/jsonlog/myspringblog/contents/docs/blog",
            async: false,//time
            data: {},
            type: "get",
            dataType: "json",
            success: function (data) {
                var blog = [];
                if (data != null) {
                    for (var j = 0; j < data.length; j++) {
                        blog.push(data[j].path.toString().replace("docs/",""));
                    }
                    // blog = ["blog/sample.html"];//test
                    githubblogAdd(blog);
                }
            },
            error: function () {
                console.log("githubajaxerror");
            }
        });
    }
    function urlClick(url) {
        var list = document.getElementsByClassName("bloglist");
        list[0].style.display = "none";

        var blogurl = document.getElementById("blogurl");
        // if(bloglist[url])
        //   blogurl.innerHTML = bloglist[url];
        // else
        //   blogurl.innerHTML =
        html(url,$("#blogurl")); //markdown
        tag(blogurl);
        blogurl.style.display = "";
        mygitment(url);
    }
    function mygitment(url) {
        var container = document.getElementById("container");
        container.style.display = "";
        var gitment = new Gitment({
            id: url.toString(), // 可选。默认为 location.href
            owner: 'jsonlog',
            repo: 'myspringblog',
            oauth: {
                client_id: '66a595b4bcb2d43ec283',
                client_secret: 'ab351cbabd4121e4626a2c85b0ba4426fd85c414',
            },
        })
        gitment.render('container')
    }
    function tagClick(tag) {
        var count = new Array();
        var list = document.getElementsByClassName("bloglist");
        var ul = document.getElementById("bloglistul");
        var li = ul.getElementsByTagName("li");
        // if(!tag && )
        if(li.length == 0){githubblog();alert("start");}
        var arr = [];
        for (var i = 0; i < li.length; i++) {
            arr.push(li[i]);
            var ids = "," + li[i].id + ",";
            if (ids.indexOf("," + tag + ",") != -1) {
                li[i].style.display = '';
                count.push(li[i]);
            } else {
                li[i].style.display = tag?'none':"";
            }
        }
        if(count.length == 1){
            // urlClick(count[0].title); //只有一篇文章直接打开,不显示列表
            var readmore = count[0].getElementsByClassName("read")[0];
            readmore.click();
            // window.location.href += "?url="+count[0].title;
            return;
        }
        arr.sort(function(a,b){
            // console.log(getDate(a.getAttribute('timer')));
            // console.log(getDate(b.getAttribute('timer')));
            // console.log(getDate(a.getAttribute('timer')) < getDate(b.getAttribute('timer')));
            return getDate(a.getAttribute('timer')) < getDate(b.getAttribute('timer'))?1:-1;
        });
        ul.innerHTML = "";
        for(var i=0;i<arr.length;i++)
        {
            ul.appendChild(arr[i]); //将排好序的元素，重新塞到body里面显示。
        }
        var main = document.getElementById("main");
        var childs = main.childNodes;
        for(var i = childs.length - 1; i >= 0; i--) {
            if(childs[i].nodeName.toLowerCase().indexOf("div")!= -1)
                childs[i].style.display = "none";
        }
        list[0].style.display = "";
    }
    function githubblogAdd(blog) {
        // var blog;
        var bloglist = {};
        var blogtagslist = new Set();
        for(var i = 0,len = blog.length; i < len; i++){
            // if(blog[i].indexOf(".md") != -1)
            //   bloglistli.innerHTML = markdown(blog[i]);
            bloglistli = bloglist[blog[i]] = {};
            var bloglistul = document.getElementById('bloglistul');
            var oDiv = document.createElement('div');
            oDiv.id = i;
            // oDiv.innerHTML = bloglistli.innerHTML;
            bloglistul.appendChild(oDiv);
            html(blog[i],$("#"+i));
            tag(oDiv,bloglistli,blogtagslist);
            var classname = oDiv.getElementsByClassName("news_title");
            bloglistli.news_title = classname[0].innerHTML;
            classname = oDiv.getElementsByClassName("timer");
            bloglistli.timer = classname[0].innerHTML;
            classname = oDiv.getElementsByClassName("news_con");
            bloglistli.news_con = classname[0].innerHTML;

            oDiv.innerHTML =
                '        <li timer="'+bloglistli.timer+'" title="'+blog[i]+'" id="'+bloglistli.tagslist+'"> <i class="blogpic"><a><img src="./../images/9.jpg" alt=""> </a></i>\n' +
                '          <dl>\n' +
                '            <dt><a>'+bloglistli.news_title+'</a></dt>\n' +
                '            <dd>\n' +
                '                <span class="bloginfo">'+bloglistli.news_con+'</span>\n' +
                '                <p class="timeinfo"><span class="tags">'+bloglistli.tags +'</span><span class="date">'+ bloglistli.timer+'</span></p>\n' +
                //              '                <p class="timeinfo"><span class="date">'+bloglistli.timer +'</span><span class="tags">'+ bloglistli.tags+'</span></p>\n' +
                '                <a class="read" href="?url='+blog[i]+'">阅读更多</a> \n' +
                '            </dd>\n' +
                '          </dl>\n' +
                '        </li>';
            if(i == blog.length - 1) {
                aside(blogtagslist);
                // tagClick();
            }
        }
    }
    function markdown(file) {
        $.ajaxSettings.async = false;
        $.get("../"+file, function(response, status, xhr){
            // $("#content").html(marked(response));
            return (marked(response));
        });
    }
    function html2(file,div) {
        $.ajax({
            url: "../"+file+" #main",
            async: false,
            type: "get",
            dataType: "html",
            success: function (data) {
                div.html(data);
            },
            error: function () {
                console.log("githubajaxerror");
            }
        });
    }
    function html(file,div) {
        div.load("../"+file+" #main");
    }
    function tag(oDiv,bloglistli,blogtagslist) {
        var classname = oDiv.getElementsByClassName("tags");
        var a=classname[0].getElementsByTagName("a");
        var tagslist = "";
        for(var j=0;j<a.length;j++){
            tagslist += ","+a[j].innerHTML;
            classname[0].innerHTML= classname[0].innerHTML.replace("<a>"+a[j].innerHTML+"</a>","<a href='#' onclick='tagClick(\""+a[j].innerHTML+"\");'>"+a[j].innerHTML+"</a>");
            if(blogtagslist) blogtagslist.add(a[j].innerHTML);
        }
        if(bloglistli)
        {
            bloglistli.tags = classname[0].innerHTML;
            bloglistli.tagslist = tagslist.substr(1);
        }
    }
    function getDate(strDate){
        var date = eval('new Date(' + strDate.replace(/\d+(?=-[^-]+$)/,
            function (d) { return parseInt(d, 10) - 1; }).match(/\d+/g) + ')');
        // console.log(strDate);
        // console.log(date);
        return date;
    }
</script>
<div id="footer"></div>
<script>
    $("#footer").load("./../jsonlog/footer.html");
</script>
<script>
    $(function(){
        /* 单机li进行页面跳转 */
        $("ul li").click(function(){
            /*当前标签下的a标签*/
            var obj = $(this).children("a");
            /*获取第一个a标签，进行跳转*/
            window.location.href=$(obj[0]).attr("href");
        });
    })
</script>
<a href="#" class="cd-top">Top</a>
</body>
</html>
